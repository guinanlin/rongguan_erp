# æˆæœ¬æ ¸ç®—ç³»ç»Ÿ - æ•°æ®åº“è¡¨è®¾è®¡ v2.0

## ğŸ“‹ è¡¨ç»“æ„æ€»è§ˆ

æœ¬ç³»ç»Ÿé‡‡ç”¨**ä¸»è¡¨+æ˜ç»†è¡¨**çš„è®¾è®¡æ–¹æ¡ˆï¼ˆä¸»è¡¨åŒ…å«æ±‡æ€»ä¿¡æ¯ï¼‰ï¼š

```
1. rg_cost_calculations      (æˆæœ¬æ ¸ç®—ä¸»è¡¨ - åŒ…å«åŸºæœ¬ä¿¡æ¯ã€ç‰ˆæœ¬ç®¡ç†ã€æˆæœ¬æ±‡æ€»)
2. rg_cost_calculation_items (æˆæœ¬æ˜ç»†ç»Ÿä¸€è¡¨)
```

**è®¾è®¡è¯´æ˜**ï¼š
- âœ… å°†æ±‡æ€»ä¿¡æ¯åˆå¹¶åˆ°ä¸»è¡¨ï¼Œé¿å…1å¯¹1çš„JOINæŸ¥è¯¢
- âœ… æ”¯æŒç‰ˆæœ¬ç®¡ç†ï¼ŒåŒä¸€æ¬¾å·å¯æœ‰å¤šä¸ªæ ¸ç®—ç‰ˆæœ¬
- âœ… å…³è”åˆåŒç¼–å·ï¼Œæ”¯æŒåˆåŒç»´åº¦æŸ¥è¯¢
- âœ… æ˜ç»†è¡¨é€šè¿‡ `item_type` åŒºåˆ†å››ç§æˆæœ¬ç±»å‹

---

## 1ï¸âƒ£ ä¸»è¡¨ï¼š`rg_cost_calculations`

### è¡¨è¯´æ˜
- **è¡¨å**: `rg_cost_calculations`
- **è¯´æ˜**: æˆæœ¬æ ¸ç®—ä¸»è¡¨ï¼Œå­˜å‚¨åŸºæœ¬ä¿¡æ¯ã€ç‰ˆæœ¬ç®¡ç†ã€å®¡æ‰¹æµç¨‹å’Œæˆæœ¬æ±‡æ€»
- **å…³ç³»**: 
  - 1å¯¹å¤š â†’ `rg_cost_calculation_items`

### å­—æ®µå®šä¹‰

#### åŸºæœ¬ä¿¡æ¯åŒº

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|------|
| **id** | VARCHAR(36) / UUID | âœ… | ä¸»é”® | PK |
| **season** | VARCHAR(50) | âŒ | å­£èŠ‚ | - |
| **customer** | VARCHAR(100) | âŒ | å®¢æˆ· | INDEX |
| **contract_no** | VARCHAR(50) | âŒ | åˆåŒç¼–å· | INDEX |
| **contract_date** | DATE | âŒ | åˆåŒæ—¥æœŸ | - |
| **order_mode** | VARCHAR(50) | âŒ | è®¢å•æ¨¡å¼ï¼ˆé»˜è®¤ï¼šç”Ÿäº§åŠ å·¥å‹ï¼‰ | - |
| **production_type** | VARCHAR(50) | âŒ | ç”Ÿäº§ç±»å‹ | - |
| **style** | VARCHAR(100) | âŒ | æ¬¾å¼ | INDEX |
| **style_number** | VARCHAR(50) | âŒ | æ¬¾å· | INDEX |
| **confirm_date** | DATE | âŒ | ç¡®è®¤æŠ¥ä»·æ—¥æœŸ | - |
| **final_customer_price** | VARCHAR(50) | âŒ | æœ€ç»ˆå®¢æˆ·ç¡®è®¤ä»· | - |
| **size_range** | VARCHAR(100) | âŒ | å°ºç èŒƒå›´ | - |
| **color_info** | VARCHAR(100) | âŒ | é¢œè‰²ä¿¡æ¯ | - |
| **has_customer_paper** | VARCHAR(20) | âŒ | æœ‰æ— å®¢ä¾›çº¸æ · | - |
| **paper_value** | VARCHAR(50) | âŒ | çº¸æ ·ä»·å€¼ | - |
| **first_order_quantity** | INTEGER | âŒ | é¦–å•æ•°é‡ | - |
| **paper_sample_maker** | VARCHAR(50) | âŒ | çº¸æ ·å¸ˆ | - |
| **style_image_url** | VARCHAR(500) | âŒ | æ¬¾å¼å›¾ç‰‡URL | - |
| **currency** | VARCHAR(10) | âŒ | å¸ç§ï¼ˆå¦‚ï¼šCNY/USDï¼‰ | - |

#### ç‰ˆæœ¬ç®¡ç†åŒº

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|------|
| **business_key** | VARCHAR(100) | âœ… | ä¸šåŠ¡ä¸»é”®ï¼ˆå®¢æˆ·+æ¬¾å·ï¼‰ | INDEX |
| **version_no** | INTEGER | âœ… | ç‰ˆæœ¬å·ï¼ˆ1, 2, 3...ï¼‰ | - |
| **is_latest_version** | BOOLEAN | âœ… | æ˜¯å¦æœ€æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤ trueï¼‰ | INDEX |
| **parent_version_id** | VARCHAR(36) | âŒ | çˆ¶ç‰ˆæœ¬IDï¼ˆä»å“ªä¸ªç‰ˆæœ¬å¤åˆ¶ï¼‰ | INDEX |
| **version_remark** | VARCHAR(200) | âŒ | ç‰ˆæœ¬è¯´æ˜ï¼ˆå¦‚ï¼šè°ƒæ•´é¢æ–™ä»·æ ¼ï¼‰ | - |

#### æˆæœ¬æ±‡æ€»åŒº

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|------|
| **fabric_cost** | DECIMAL(10,2) | âœ… | é¢æ–™æ€»æˆæœ¬ | - |
| **accessory_cost** | DECIMAL(10,2) | âœ… | è¾…æ–™æ€»æˆæœ¬ | - |
| **process_cost** | DECIMAL(10,2) | âœ… | ç‰¹æ®Šå·¥è‰ºæ€»æˆæœ¬ | - |
| **production_cost** | DECIMAL(10,2) | âœ… | ç”Ÿäº§å…¶ä»–æˆæœ¬ | - |
| **total_production_cost** | DECIMAL(10,2) | âœ… | ç”Ÿäº§æ€»æˆæœ¬ | - |
| **profit_percentage** | DECIMAL(5,2) | âœ… | åˆ©æ¶¦ç™¾åˆ†æ¯”(%)ï¼Œé»˜è®¤15 | - |
| **profit_amount** | DECIMAL(10,2) | âœ… | åˆ©æ¶¦é‡‘é¢ | - |
| **fob_price** | DECIMAL(10,2) | âœ… | FOBæ€»ä»· | - |
| **fob_usd_price** | VARCHAR(50) | âŒ | FOBç¾é‡‘ä»·æ ¼ | - |

#### å®¡æ‰¹æµç¨‹åŒº

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|------|
| **status** | VARCHAR(20) | âœ… | çŠ¶æ€: draft/pending/approved/rejected | INDEX |
| **creator** | VARCHAR(50) | âŒ | åˆ¶è¡¨äºº | INDEX |
| **reviewer** | VARCHAR(50) | âŒ | å®¡æ ¸äºº | - |
| **approver** | VARCHAR(50) | âŒ | å®¡æ‰¹äºº | - |

#### æ—¶é—´æˆ³åŒº

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|------|
| **created_at** | TIMESTAMP | âœ… | åˆ›å»ºæ—¶é—´ | INDEX |
| **updated_at** | TIMESTAMP | âœ… | æ›´æ–°æ—¶é—´ | - |

### ç´¢å¼•è®¾è®¡
```sql
PRIMARY KEY (id)
INDEX idx_customer (customer)
INDEX idx_contract_no (contract_no)
INDEX idx_style (style)
INDEX idx_style_number (style_number)
INDEX idx_business_key (business_key)
INDEX idx_latest_version (business_key, is_latest_version)
INDEX idx_parent_version (parent_version_id)
INDEX idx_status (status)
INDEX idx_creator (creator)
INDEX idx_created_at (created_at)
UNIQUE INDEX idx_business_version (business_key, version_no)
```

### é‡è¦çº¦æŸ
```sql
-- ç¡®ä¿åŒä¸€ä¸šåŠ¡ä¸»é”®ä¸‹ç‰ˆæœ¬å·å”¯ä¸€
UNIQUE (business_key, version_no)

-- ä¸šåŠ¡ä¸»é”®ç”Ÿæˆè§„åˆ™
business_key = customer + '-' + style_number
-- ä¾‹å¦‚: "ZARA-SS2025-001"
```

---

## 2ï¸âƒ£ æ˜ç»†è¡¨ï¼š`rg_cost_calculation_items`

### è¡¨è¯´æ˜
- **è¡¨å**: `rg_cost_calculation_items`
- **è¯´æ˜**: æˆæœ¬æ˜ç»†ç»Ÿä¸€è¡¨ï¼Œé€šè¿‡`item_type`åŒºåˆ†å››ç§ç±»å‹
  - `fabric`: é¢æ–™
  - `accessory`: è¾…æ–™
  - `process`: ç‰¹æ®Šå·¥è‰º
  - `production`: ç”Ÿäº§å…¶ä»–æˆæœ¬
- **å…³ç³»**: å¤šå¯¹1 â†’ `rg_cost_calculations`

### å­—æ®µå®šä¹‰

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é€‚ç”¨ç±»å‹ |
|--------|------|------|------|----------|
| **id** | VARCHAR(36) / UUID | âœ… | ä¸»é”® | ALL |
| **calculation_id** | VARCHAR(36) | âœ… | å¤–é”® â†’ rg_cost_calculations.id | ALL |
| **item_type** | VARCHAR(20) | âœ… | æ˜ç»†ç±»å‹: fabric/accessory/process/production | ALL |
| **sequence** | INTEGER | âœ… | åºå·ï¼ˆç”¨äºæ’åºï¼‰ | ALL |
| | | | | |
| **material_code** | VARCHAR(50) | âŒ | ç‰©æ–™ç¼–ç  | fabric, accessory, process |
| **supplier** | VARCHAR(100) | âŒ | ä¾›åº”å•†ï¼ˆç”Ÿäº§æˆæœ¬æ—¶å­˜è´¹ç”¨åç§°ï¼‰ | ALL |
| **name** | VARCHAR(100) | âŒ | ç‰©æ–™åç§° | fabric, accessory, process |
| **color** | VARCHAR(50) | âŒ | é¢œè‰² | fabric, accessory |
| **property** | VARCHAR(100) | âŒ | ç‰¹æ€§/å±æ€§ | fabric, accessory, process |
| | | | | |
| **unit_price** | DECIMAL(10,2) | âŒ | å«ç¨å•ä»· | ALL |
| **net_consumption** | DECIMAL(10,4) | âŒ | å‡€è€— | fabric, accessory, process |
| **loss_rate** | DECIMAL(5,2) | âŒ | æŸè€—ç‡(%) | ALL |
| **total_consumption** | DECIMAL(10,4) | âŒ | æ€»è€—ï¼ˆè®¡ç®—å­—æ®µï¼‰ | fabric, accessory, process |
| **amount** | DECIMAL(10,2) | âŒ | é‡‘é¢ï¼ˆè®¡ç®—å­—æ®µï¼‰ | ALL |
| | | | | |
| **weight** | VARCHAR(50) | âŒ | å…‹é‡(g) | fabric |
| **width** | VARCHAR(50) | âŒ | é—¨å¹… | fabric |
| **unit** | VARCHAR(20) | âŒ | å•ä½ | accessory |
| **position** | VARCHAR(100) | âŒ | å·¥è‰ºä½ç½® | process |
| | | | | |
| **description** | VARCHAR(200) | âŒ | è´¹ç”¨è¯´æ˜ | production |
| **difficulty_point** | VARCHAR(200) | âŒ | æ­¤æ¬¾å·¥è‰ºéš¾ç‚¹ | production |
| **quantity** | DECIMAL(10,2) | âŒ | å•ä»¶æ•°é‡ | production |
| **work_hours** | DECIMAL(10,2) | âŒ | å·¥æ—¶ | production |
| | | | | |
| **created_at** | TIMESTAMP | âœ… | åˆ›å»ºæ—¶é—´ | ALL |
| **updated_at** | TIMESTAMP | âœ… | æ›´æ–°æ—¶é—´ | ALL |

### ç´¢å¼•è®¾è®¡
```sql
PRIMARY KEY (id)
INDEX idx_calculation_id (calculation_id)
INDEX idx_calculation_type (calculation_id, item_type)
INDEX idx_sequence (calculation_id, sequence)
FOREIGN KEY (calculation_id) REFERENCES rg_cost_calculations(id) ON DELETE CASCADE
```

### å­—æ®µä½¿ç”¨çŸ©é˜µ

| å­—æ®µ | fabric | accessory | process | production |
|------|--------|-----------|---------|------------|
| material_code | âœ… | âœ… | âœ… | âŒ |
| supplier | âœ… | âœ… | âœ… | âœ… (è´¹ç”¨åç§°) |
| name | âœ… | âœ… | âœ… | âŒ |
| color | âœ… | âœ… | âŒ | âŒ |
| property | âœ… | âœ… | âœ… | âŒ |
| unit_price | âœ… | âœ… | âœ… | âœ… |
| net_consumption | âœ… | âœ… | âœ… | âŒ |
| loss_rate | âœ… | âœ… | âœ… | âœ… |
| total_consumption | âœ… | âœ… | âœ… | âŒ |
| amount | âœ… | âœ… | âœ… | âœ… |
| weight | âœ… | âŒ | âŒ | âŒ |
| width | âœ… | âŒ | âŒ | âŒ |
| unit | âŒ | âœ… | âŒ | âŒ |
| position | âŒ | âŒ | âœ… | âŒ |
| description | âŒ | âŒ | âŒ | âœ… |
| difficulty_point | âŒ | âŒ | âŒ | âœ… |
| quantity | âŒ | âŒ | âŒ | âœ… |
| work_hours | âŒ | âŒ | âŒ | âœ… |

---

## ğŸ“ è®¡ç®—é€»è¾‘

### æ˜ç»†è¡¨è®¡ç®—å…¬å¼

```javascript
// é€šç”¨è®¡ç®—ï¼ˆé¢æ–™ã€è¾…æ–™ã€å·¥è‰ºï¼‰
total_consumption = net_consumption Ã— (1 + loss_rate / 100)
amount = unit_price Ã— total_consumption

// ç”Ÿäº§æˆæœ¬è®¡ç®—
amount = unit_price Ã— quantity
```

### ä¸»è¡¨æ±‡æ€»è®¡ç®—å…¬å¼

```javascript
// åˆ†ç±»æˆæœ¬æ±‡æ€»ï¼ˆä»æ˜ç»†è¡¨èšåˆï¼‰
fabric_cost = SUM(amount WHERE item_type='fabric')
accessory_cost = SUM(amount WHERE item_type='accessory')
process_cost = SUM(amount WHERE item_type='process')
production_cost = SUM(amount WHERE item_type='production')

// æ€»æˆæœ¬å’ŒæŠ¥ä»·
total_production_cost = fabric_cost + accessory_cost + process_cost + production_cost
profit_amount = total_production_cost Ã— (profit_percentage / 100)
fob_price = total_production_cost + profit_amount
```

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹ä¸æ•°æ®æµè½¬

### çŠ¶æ€æµè½¬

```mermaid
graph LR
    A[è‰ç¨¿ draft] --> B[å¾…å®¡æ ¸ pending]
    B --> C[å·²æ‰¹å‡† approved]
    B --> D[å·²æ‹’ç» rejected]
    D --> B
    C --> E[é”å®šä¸å¯ä¿®æ”¹]
```

### ç‰ˆæœ¬ç®¡ç†æµç¨‹

```mermaid
graph TD
    A[åˆ›å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬] --> B[business_key: å®¢æˆ·A-æ¬¾å·123]
    B --> C[version_no: 1]
    C --> D[is_latest_version: true]
    D --> E{éœ€è¦è°ƒæ•´ä»·æ ¼?}
    E -->|æ˜¯| F[å¤åˆ¶åˆ›å»ºæ–°ç‰ˆæœ¬]
    F --> G[version_no: 2]
    G --> H[æ—§ç‰ˆæœ¬ is_latest_version: false]
    G --> I[æ–°ç‰ˆæœ¬ is_latest_version: true]
    G --> J[parent_version_id: ç‰ˆæœ¬1çš„ID]
```

### æ•°æ®æ“ä½œæµç¨‹

1. **åˆ›å»ºé¦–ä¸ªç‰ˆæœ¬**
   ```sql
   -- ç”Ÿæˆ business_key
   business_key = customer + '-' + style_number
   
   -- åˆå§‹ç‰ˆæœ¬
   version_no = 1
   is_latest_version = true
   parent_version_id = NULL
   status = 'draft'
   
   -- åˆå§‹åŒ–æ±‡æ€»å­—æ®µä¸º0
   fabric_cost = 0
   accessory_cost = 0
   ...
   ```

2. **å½•å…¥æ˜ç»†æ•°æ®**
   - æ’å…¥/æ›´æ–° `rg_cost_calculation_items` è®°å½•
   - å®æ—¶è®¡ç®— `total_consumption` å’Œ `amount`

3. **è®¡ç®—æ±‡æ€»**
   - æ ¹æ®æ˜ç»†è¡¨ç»Ÿè®¡å„ç±»æˆæœ¬
   - æ›´æ–°ä¸»è¡¨çš„æ±‡æ€»å­—æ®µ

4. **åˆ›å»ºæ–°ç‰ˆæœ¬**
   ```sql
   -- æŸ¥è¯¢å½“å‰æœ€å¤§ç‰ˆæœ¬å·
   SELECT MAX(version_no) FROM rg_cost_calculations 
   WHERE business_key = 'å®¢æˆ·A-æ¬¾å·123'
   
   -- å¤åˆ¶æ—§ç‰ˆæœ¬æ•°æ®
   INSERT INTO rg_cost_calculations (...)
   SELECT ... FROM rg_cost_calculations WHERE id = 'æ—§ç‰ˆæœ¬ID'
   
   -- è®¾ç½®æ–°ç‰ˆæœ¬ä¿¡æ¯
   version_no = æ—§ç‰ˆæœ¬ + 1
   is_latest_version = true
   parent_version_id = 'æ—§ç‰ˆæœ¬ID'
   version_remark = 'è°ƒæ•´é¢æ–™ä»·æ ¼'
   
   -- å°†æ—§ç‰ˆæœ¬æ ‡è®°ä¸ºéæœ€æ–°
   UPDATE rg_cost_calculations 
   SET is_latest_version = false 
   WHERE id = 'æ—§ç‰ˆæœ¬ID'
   ```

5. **æäº¤å®¡æ ¸**
   - æ›´æ–° `status='pending'`
   - é”å®šæ˜ç»†æ•°æ®ï¼Œä¸å¯ç¼–è¾‘

6. **å®¡æ‰¹æ“ä½œ**
   - æ‰¹å‡†ï¼š`status='approved'`ï¼Œæ•°æ®æ°¸ä¹…é”å®š
   - æ‹’ç»ï¼š`status='rejected'`ï¼Œå¯ä¿®æ”¹åé‡æ–°æäº¤

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### âœ… ä¼˜ç‚¹

1. **ç®€åŒ–æ¶æ„**
   - åªæœ‰2å¼ è¡¨ï¼Œç»“æ„æ¸…æ™°
   - é¿å…1å¯¹1çš„JOINæŸ¥è¯¢
   - æŸ¥è¯¢æ€§èƒ½æ›´å¥½

2. **ç‰ˆæœ¬ç®¡ç†å®Œå–„**
   - æ”¯æŒåŒä¸€æ¬¾å·å¤šç‰ˆæœ¬æ ¸ç®—
   - å¯è¿½æº¯ç‰ˆæœ¬æ¼”å˜é“¾è·¯
   - å¿«é€ŸæŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬

3. **ä¸šåŠ¡å®Œæ•´æ€§**
   - ä¸€å¼ ä¸»è¡¨åŒ…å«å®Œæ•´çš„æˆæœ¬æ ¸ç®—ä¿¡æ¯
   - ç¬¦åˆä¸šåŠ¡äººå‘˜ç†è§£
   - å‰ç«¯å¯¹è±¡æ˜ å°„æ›´ç®€å•

4. **åˆåŒå…³è”**
   - æ”¯æŒä»åˆåŒç»´åº¦æŸ¥è¯¢æˆæœ¬æ ¸ç®—
   - ä¾¿äºåˆåŒå±¥çº¦ç®¡ç†

5. **æ•°æ®å®Œæ•´æ€§**
   - å¤–é”®çº¦æŸç¡®ä¿å…³è”æ­£ç¡®
   - å”¯ä¸€ç´¢å¼•ç¡®ä¿ç‰ˆæœ¬å·ä¸é‡å¤
   - çº§è”åˆ é™¤ä¿è¯æ•°æ®ä¸€è‡´æ€§

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ±‡æ€»å­—æ®µæ›´æ–°**
   - æ˜ç»†æ•°æ®å˜åŒ–æ—¶ï¼Œéœ€åŒæ­¥æ›´æ–°ä¸»è¡¨æ±‡æ€»å­—æ®µ
   - å»ºè®®åœ¨åº”ç”¨å±‚æˆ–æ•°æ®åº“è§¦å‘å™¨ä¸­å®ç°

2. **ç‰ˆæœ¬åˆ›å»º**
   - å¿…é¡»å…ˆæŸ¥è¯¢æœ€å¤§ç‰ˆæœ¬å·
   - å¿…é¡»æ›´æ–°æ—§ç‰ˆæœ¬çš„ `is_latest_version` æ ‡å¿—
   - å»ºè®®ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§

3. **æ•°æ®é”å®š**
   - çŠ¶æ€ä¸º `approved` åï¼Œåº”ç¦æ­¢ä¿®æ”¹
   - å»ºè®®å¢åŠ æ•°æ®åº“è§¦å‘å™¨æˆ–åº”ç”¨å±‚æ ¡éªŒ

4. **business_key ç”Ÿæˆ**
   - ç¡®ä¿å”¯ä¸€æ€§å’Œå¯è¯»æ€§
   - å»ºè®®æ ¼å¼ï¼š`{customer}-{style_number}`

---

## ğŸ“ SQL åˆ›å»ºè„šæœ¬

```sql
-- ä¸»è¡¨
CREATE TABLE rg_cost_calculations (
    id VARCHAR(36) PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    season VARCHAR(50),
    customer VARCHAR(100),
    contract_no VARCHAR(50),
    contract_date DATE,
    order_mode VARCHAR(50),
    production_type VARCHAR(50),
    style VARCHAR(100),
    style_number VARCHAR(50),
    confirm_date DATE,
    final_customer_price VARCHAR(50),
    size_range VARCHAR(100),
    color_info VARCHAR(100),
    has_customer_paper VARCHAR(20),
    paper_value VARCHAR(50),
    first_order_quantity INTEGER,
    paper_sample_maker VARCHAR(50),
    style_image_url VARCHAR(500),
    currency VARCHAR(10),
    
    -- ç‰ˆæœ¬ç®¡ç†
    business_key VARCHAR(100) NOT NULL,
    version_no INTEGER NOT NULL,
    is_latest_version BOOLEAN NOT NULL DEFAULT true,
    parent_version_id VARCHAR(36),
    version_remark VARCHAR(200),
    
    -- æˆæœ¬æ±‡æ€»
    fabric_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    accessory_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    process_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    production_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    total_production_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    profit_percentage DECIMAL(5,2) NOT NULL DEFAULT 15.00,
    profit_amount DECIMAL(10,2) NOT NULL DEFAULT 0,
    fob_price DECIMAL(10,2) NOT NULL DEFAULT 0,
    fob_usd_price VARCHAR(50),
    
    -- å®¡æ‰¹æµç¨‹
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    creator VARCHAR(50),
    reviewer VARCHAR(50),
    approver VARCHAR(50),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_customer (customer),
    INDEX idx_contract_no (contract_no),
    INDEX idx_style (style),
    INDEX idx_style_number (style_number),
    INDEX idx_business_key (business_key),
    INDEX idx_latest_version (business_key, is_latest_version),
    INDEX idx_parent_version (parent_version_id),
    INDEX idx_status (status),
    INDEX idx_creator (creator),
    INDEX idx_created_at (created_at),
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE INDEX idx_business_version (business_key, version_no)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æˆæœ¬æ ¸ç®—ä¸»è¡¨';

-- æ˜ç»†è¡¨
CREATE TABLE rg_cost_calculation_items (
    id VARCHAR(36) PRIMARY KEY,
    calculation_id VARCHAR(36) NOT NULL,
    item_type VARCHAR(20) NOT NULL COMMENT 'fabric/accessory/process/production',
    sequence INTEGER NOT NULL,
    
    -- é€šç”¨å­—æ®µ
    material_code VARCHAR(50),
    supplier VARCHAR(100),
    name VARCHAR(100) COMMENT 'ç‰©æ–™åç§°',
    color VARCHAR(50),
    property VARCHAR(100),
    
    -- ä»·æ ¼å’Œæ¶ˆè€—
    unit_price DECIMAL(10,2),
    net_consumption DECIMAL(10,4),
    loss_rate DECIMAL(5,2),
    total_consumption DECIMAL(10,4),
    amount DECIMAL(10,2),
    
    -- é¢æ–™ç‰¹æœ‰
    weight VARCHAR(50),
    width VARCHAR(50),
    
    -- è¾…æ–™ç‰¹æœ‰
    unit VARCHAR(20),
    
    -- å·¥è‰ºç‰¹æœ‰
    position VARCHAR(100),
    
    -- ç”Ÿäº§æˆæœ¬ç‰¹æœ‰
    description VARCHAR(200),
    difficulty_point VARCHAR(200),
    quantity DECIMAL(10,2),
    work_hours DECIMAL(10,2),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_calculation_id (calculation_id),
    INDEX idx_calculation_type (calculation_id, item_type),
    INDEX idx_sequence (calculation_id, sequence),
    
    -- å¤–é”®
    FOREIGN KEY (calculation_id) REFERENCES rg_cost_calculations(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æˆæœ¬æ˜ç»†ç»Ÿä¸€è¡¨';
```

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æŸæ¬¾å·çš„æœ€æ–°ç‰ˆæœ¬

```sql
SELECT * FROM rg_cost_calculations 
WHERE business_key = 'å®¢æˆ·A-æ¬¾å·123' 
AND is_latest_version = true;
```

### æŸ¥è¯¢æŸæ¬¾å·çš„æ‰€æœ‰å†å²ç‰ˆæœ¬

```sql
SELECT 
    version_no,
    version_remark,
    fob_price,
    profit_percentage,
    status,
    created_at
FROM rg_cost_calculations
WHERE business_key = 'å®¢æˆ·A-æ¬¾å·123'
ORDER BY version_no DESC;
```

### æŸ¥è¯¢å®Œæ•´çš„æˆæœ¬æ ¸ç®—å•ï¼ˆå«æ˜ç»†ï¼‰

```sql
SELECT 
    c.*,
    (SELECT JSON_ARRAYAGG(JSON_OBJECT(
        'id', id,
        'material_code', material_code,
        'supplier', supplier,
        'name', name,
        'amount', amount
    )) FROM rg_cost_calculation_items WHERE calculation_id = c.id AND item_type = 'fabric') as fabric_items,
    (SELECT JSON_ARRAYAGG(JSON_OBJECT(
        'id', id,
        'material_code', material_code,
        'supplier', supplier,
        'name', name,
        'amount', amount
    )) FROM rg_cost_calculation_items WHERE calculation_id = c.id AND item_type = 'accessory') as accessory_items,
    (SELECT JSON_ARRAYAGG(JSON_OBJECT(
        'id', id,
        'material_code', material_code,
        'supplier', supplier,
        'name', name,
        'amount', amount
    )) FROM rg_cost_calculation_items WHERE calculation_id = c.id AND item_type = 'process') as process_items,
    (SELECT JSON_ARRAYAGG(JSON_OBJECT(
        'id', id,
        'supplier', supplier,
        'description', description,
        'amount', amount
    )) FROM rg_cost_calculation_items WHERE calculation_id = c.id AND item_type = 'production') as production_items
FROM rg_cost_calculations c
WHERE c.id = 'xxx';
```

### æŸ¥è¯¢æŸåˆåŒçš„æ‰€æœ‰æˆæœ¬æ ¸ç®—

```sql
SELECT 
    id,
    customer,
    style_number,
    version_no,
    is_latest_version,
    fob_price,
    status,
    created_at
FROM rg_cost_calculations
WHERE contract_no = 'CONTRACT-2025-001'
ORDER BY business_key, version_no;
```

### ç»Ÿè®¡æŸå®¢æˆ·çš„æˆæœ¬æ ¸ç®—æ±‡æ€»

```sql
SELECT 
    customer,
    COUNT(DISTINCT business_key) as style_count,
    COUNT(*) as total_versions,
    AVG(fob_price) as avg_fob_price,
    SUM(CASE WHEN is_latest_version = true THEN fob_price ELSE 0 END) as total_latest_fob_price
FROM rg_cost_calculations
WHERE customer = 'xxx' AND status = 'approved'
GROUP BY customer;
```

### ç‰ˆæœ¬å¯¹æ¯”æŸ¥è¯¢

```sql
SELECT 
    v1.version_no as version_1,
    v2.version_no as version_2,
    v1.fob_price as fob_price_v1,
    v2.fob_price as fob_price_v2,
    (v2.fob_price - v1.fob_price) as price_diff,
    v1.fabric_cost as fabric_cost_v1,
    v2.fabric_cost as fabric_cost_v2,
    v2.version_remark as change_reason
FROM rg_cost_calculations v1
JOIN rg_cost_calculations v2 ON v1.id = v2.parent_version_id
WHERE v1.business_key = 'å®¢æˆ·A-æ¬¾å·123';
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ›å»ºæ–°ç‰ˆæœ¬çš„æ ‡å‡†æµç¨‹

```javascript
async function createNewVersion(oldVersionId, versionRemark) {
  const transaction = await db.beginTransaction();
  
  try {
    // 1. æŸ¥è¯¢æ—§ç‰ˆæœ¬
    const oldVersion = await db.query(
      'SELECT * FROM rg_cost_calculations WHERE id = ?', 
      [oldVersionId]
    );
    
    // 2. æŸ¥è¯¢å½“å‰æœ€å¤§ç‰ˆæœ¬å·
    const maxVersion = await db.query(
      'SELECT MAX(version_no) as max FROM rg_cost_calculations WHERE business_key = ?',
      [oldVersion.business_key]
    );
    
    // 3. æ’å…¥æ–°ç‰ˆæœ¬
    const newVersion = {
      ...oldVersion,
      id: generateUUID(),
      version_no: maxVersion.max + 1,
      is_latest_version: true,
      parent_version_id: oldVersionId,
      version_remark: versionRemark,
      status: 'draft',
      created_at: new Date(),
      updated_at: new Date()
    };
    
    await db.insert('rg_cost_calculations', newVersion);
    
    // 4. æ›´æ–°æ—§ç‰ˆæœ¬æ ‡è®°
    await db.update(
      'rg_cost_calculations',
      { is_latest_version: false },
      { id: oldVersionId }
    );
    
    // 5. å¤åˆ¶æ˜ç»†æ•°æ®ï¼ˆå¯é€‰ï¼‰
    await db.query(`
      INSERT INTO rg_cost_calculation_items 
        (id, calculation_id, item_type, sequence, ...)
      SELECT 
        UUID(), ?, item_type, sequence, ...
      FROM rg_cost_calculation_items
      WHERE calculation_id = ?
    `, [newVersion.id, oldVersionId]);
    
    await transaction.commit();
    return newVersion;
    
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

### 2. æ›´æ–°æ±‡æ€»å­—æ®µçš„è§¦å‘å™¨ï¼ˆå¯é€‰ï¼‰

```sql
DELIMITER $$

CREATE TRIGGER update_cost_summary
AFTER INSERT ON rg_cost_calculation_items
FOR EACH ROW
BEGIN
    UPDATE rg_cost_calculations
    SET 
        fabric_cost = (
            SELECT COALESCE(SUM(amount), 0) 
            FROM rg_cost_calculation_items 
            WHERE calculation_id = NEW.calculation_id AND item_type = 'fabric'
        ),
        accessory_cost = (
            SELECT COALESCE(SUM(amount), 0) 
            FROM rg_cost_calculation_items 
            WHERE calculation_id = NEW.calculation_id AND item_type = 'accessory'
        ),
        process_cost = (
            SELECT COALESCE(SUM(amount), 0) 
            FROM rg_cost_calculation_items 
            WHERE calculation_id = NEW.calculation_id AND item_type = 'process'
        ),
        production_cost = (
            SELECT COALESCE(SUM(amount), 0) 
            FROM rg_cost_calculation_items 
            WHERE calculation_id = NEW.calculation_id AND item_type = 'production'
        )
    WHERE id = NEW.calculation_id;
    
    UPDATE rg_cost_calculations
    SET 
        total_production_cost = fabric_cost + accessory_cost + process_cost + production_cost,
        profit_amount = (fabric_cost + accessory_cost + process_cost + production_cost) * profit_percentage / 100,
        fob_price = (fabric_cost + accessory_cost + process_cost + production_cost) * (1 + profit_percentage / 100)
    WHERE id = NEW.calculation_id;
END$$

DELIMITER ;
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-14  
**æœ€åæ›´æ–°**: 2025-10-14  
**ä¸»è¦å˜æ›´**:
- åˆå¹¶æ±‡æ€»è¡¨åˆ°ä¸»è¡¨
- æ–°å¢ç‰ˆæœ¬ç®¡ç†å­—æ®µ
- æ–°å¢åˆåŒç¼–å·å­—æ®µ
- ç®€åŒ–ä¸ºä¸¤å¼ è¡¨è®¾è®¡
